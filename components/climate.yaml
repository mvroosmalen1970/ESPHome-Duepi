climate:
  - platform: template
    name: "Pellet kachel"
    id: Stove
    sensor: room_temp_stove

    min_temperature: 10
    max_temperature: 35

    modes:
      - OFF
      - HEAT

    visual:
      min_temperature: 10
      max_temperature: 35
      temperature_step:
        target_temperature: 1.0
        current_temperature: 0.1

  action:
    # Derive the UI hvac_action from the same string we expose to HA as burner status.
    # This avoids mismatches where HA shows burner_status="Stove On" but hvac_action="idle".
    lambda: |-
      if (id(Stove).mode == esphome::climate::CLIMATE_MODE_OFF) {
        return esphome::climate::CLIMATE_ACTION_OFF;
      }

      const std::string s = id(burner_status).state;
      const bool heating =
        // positive states
        (s.find("Stove On") != std::string::npos) ||
        (s.find("Cleaning") != std::string::npos) ||
        (s.find("Ignition") != std::string::npos) ||
        // firmware-specific variants
        (s.find("fire on") != std::string::npos) ||
        (s.find("Fire on") != std::string::npos);

      const bool explicitly_not_heating =
        (s.find("Eco Idle") != std::string::npos) ||
        (s.find("Cooldown") != std::string::npos) ||
        (s.find("wait for cooldown") != std::string::npos) ||
        (s.find("Off") != std::string::npos) ||
        (s.find("OFF") != std::string::npos);

      if (heating && !explicitly_not_heating) {
        return esphome::climate::CLIMATE_ACTION_HEATING;
      }
      return esphome::climate::CLIMATE_ACTION_IDLE;
    heat_action:
      then:
        - wait_until:
            condition:
              lambda: 'return (id(uart_send) == 0);'
            timeout: 1s
        - script.execute:
            id: UART_CMD
            command_in: !lambda |-
              id(debug).publish_state("Heat On");
              id(uart_send) = 9;
              std::string str;
              if (id(firmware) == "9200") { str="F005"; }
              else if (id(firmware) == "E670") { str="F006"; }
              else if (id(firmware) == "E693") { str="F006"; }
              else if (id(firmware) == "V100") { str="F006"; }
              else { str="F001"; }
              return str;
        - script.wait: UART_CMD
        - wait_until:
            condition:
              lambda: 'return (id(uart_send) == 0);'
            timeout: 100ms
        - if:
            condition:
              lambda: 'return (id(debug).state != "OK");'
            then:
              - lambda: id(debug).publish_state("Stove failed Heat On");
        - lambda: id(uart_send) = 1;

    # Quand HA met le mode OFF -> envoi Heat OFF
    off_action:
      then:
        - wait_until:
            condition:
              lambda: 'return (id(uart_send) == 0);'
            timeout: 1s
        - lambda: |-
            id(debug).publish_state("Heat OFF");
            id(uart_send) = 9;
        - uart.write: "\x1bRF000058&"
        - wait_until:
            condition:
              lambda: 'return (id(uart_send) == 0);'
            timeout: 100ms
        - if:
            condition:
              lambda: 'return (id(debug).state != "OK");'
            then:
              - lambda: id(debug).publish_state("Stove failed Heat Off");
        - lambda: id(uart_send) = 1;

    # Changement de consigne depuis HA
    set_temperature_action:
      then:
        - wait_until:
            condition:
              lambda: 'return (id(uart_send) == 0);'
            timeout: 1s
        - script.execute:
            id: UART_CMD
            command_in: !lambda |-
              std::string str;
              int temp = (int) x;   // x = nouvelle consigne demandée depuis HA
              if (temp < 10 || temp > 35) {
                id(debug).publish_state("Temperature out of range (10-35). Set to 21");
                temp = 21;
              }
              str = str_sprintf("%X", temp);
              if (str.length() == 1) str = "F20" + str;
              else str = "F2" + str;
              id(uart_send) = 9;
              return str;
        - script.wait: UART_CMD
        - wait_until:
            condition:
              lambda: 'return (id(uart_send) == 0);'
            timeout: 100ms
        - if:
            condition:
              lambda: 'return (id(debug).state != "OK");'
            then:
              - lambda: id(debug).publish_state("Stove temp change failed");

    # Tes fan modes (inchangé)
    fan_mode_quiet_action:
      then:
        - lambda: id(fan_mode) = 1;
    fan_mode_low_action:
      then:
        - lambda: id(fan_mode) = 2;
    fan_mode_middle_action:
      then:
        - lambda: id(fan_mode) = 3;
    fan_mode_medium_action:
      then:
        - lambda: id(fan_mode) = 4;
    fan_mode_high_action:
      then:
        - lambda: id(fan_mode) = 5;
